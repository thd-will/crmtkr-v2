<?php

namespace App\Filament\Resources\Customers\Tables;

use Filament\Actions\BulkActionGroup;
use Filament\Actions\DeleteBulkAction;
use Filament\Actions\EditAction;
use Filament\Actions\ViewAction;
use Filament\Actions\Action;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Columns\IconColumn;
use Filament\Tables\Table;
use Filament\Forms\Components\Repeater;
use Filament\Forms\Components\Select;
use Filament\Forms\Components\TextInput;
use Filament\Forms\Components\Hidden;
use Filament\Notifications\Notification;

class CustomersTable
{
    public static function configure(Table $table): Table
    {
        return $table
            ->columns([
                TextColumn::make('name')
                    ->searchable()
                    ->url(fn ($record) => route('filament.admin.resources.customers.view', $record)),
                TextColumn::make('phone')
                    ->searchable(),
                TextColumn::make('line_id')
                    ->searchable(),
                TextColumn::make('purchase_type')
                    ->label('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏ô‡πÉ‡∏à')
                    ->formatStateUsing(function ($state): string {
                        if (is_array($state)) {
                            return implode(', ', $state);
                        }
                        return $state ?? '-';
                    })
                    ->badge()
                    ->separator(','),
                TextColumn::make('default_discount_mou')
                    ->label('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î MOU')
                    ->money('THB')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('default_discount_moti24')
                    ->label('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ‡∏°‡∏ï‡∏¥24')
                    ->money('THB')
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('current_credit')
                    ->label('‡πÄ‡∏Ñ‡∏£‡∏î‡∏¥‡∏ï')
                    ->money('THB')
                    ->sortable(),
                TextColumn::make('discounts')
                ->label('‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô')
                ->formatStateUsing(function ($state, $record) {
                    try {
                        // ‡πÉ‡∏ä‡πâ method ‡∏à‡∏≤‡∏Å Customer model ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥
                        $mouDiscount = $record->getDiscountFor('MOU', '6_months');
                        $moti24Discount = $record->getDiscountFor('‡∏°‡∏ï‡∏¥24', '6_months');
                        
                        $results = [];
                        
                        if ($mouDiscount > 0) {
                            $results[] = "MOU: ‡∏ø" . number_format($mouDiscount, 0);
                        }
                        
                        if ($moti24Discount > 0) {
                            $results[] = "‡∏°‡∏ï‡∏¥24: ‡∏ø" . number_format($moti24Discount, 0);
                        }
                        
                        return !empty($results) ? implode(' | ', $results) : '';
                    } catch (\Exception $e) {
                        // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ error ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô
                        return 'Error: ' . $e->getMessage();
                    }
                })
                ->sortable(false)
                ->searchable(false)
                ->wrap(),
                TextColumn::make('days_missing')
                    ->numeric()
                    ->sortable(),
                IconColumn::make('is_active')
                    ->boolean(),
                TextColumn::make('created_at')
                    ->dateTime()
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
                TextColumn::make('updated_at')
                    ->dateTime()
                    ->sortable()
                    ->toggleable(isToggledHiddenByDefault: true),
            ])
            ->filters([
                //
            ])
            ->recordActions([
                ViewAction::make()
                    ->label('‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î'),
                EditAction::make()
                    ->label('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç'),
                Action::make('edit_discounts')
                    ->label('‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î')
                    ->icon('heroicon-o-pencil-square')
                    ->color('warning')
                    ->form([
                        Repeater::make('discounts')
                            ->label('üè∑Ô∏è ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏û‡∏¥‡πÄ‡∏®‡∏©')
                            ->helperText('‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô + ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏±‡∏ô‡∏ó‡∏µ')
                            ->schema([
                                Select::make('insurance_type')
                                    ->label('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô')
                                    ->options([
                                        'MOU' => 'üîµ MOU',
                                        '‡∏°‡∏ï‡∏¥24' => 'üü¢ ‡∏°‡∏ï‡∏¥24',
                                    ])
                                    ->required()
                                    ->live()
                                    ->afterStateUpdated(function ($state, $set, $get) {
                                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡πÅ‡∏ö‡∏ö real-time
                                        self::checkDuplicateDiscount($get, $set);
                                    }),
                                
                                Select::make('duration')
                                    ->label('‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤ & ‡∏£‡∏≤‡∏Ñ‡∏≤')
                                    ->options([
                                        '3_months' => '3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏ø590',
                                        '6_months' => '6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏ø990',
                                        '12_months' => '12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏ø1,750',
                                        '15_months' => '15 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô ‚Üí ‡∏ø2,290',
                                    ])
                                    ->required()
                                    ->live()
                                    ->afterStateUpdated(function ($state, $set, $get) {
                                        self::checkDuplicateDiscount($get, $set);
                                    }),
                                
                                TextInput::make('discount_amount')
                                    ->label('üí∞ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡∏ö‡∏≤‡∏ó/‡∏Ñ‡∏ô)')
                                    ->numeric()
                                    ->minValue(0)
                                    ->step(0.01)
                                    ->prefix('‡∏ø')
                                    ->required(),
                                    
                                Hidden::make('is_duplicate')
                                    ->default(false),
                            ])
                            ->itemLabel(function (array $state): ?string {
                                $type = $state['insurance_type'] ?? '';
                                $duration = $state['duration'] ?? '';
                                $amount = $state['discount_amount'] ?? 0;
                                $isDuplicate = $state['is_duplicate'] ?? false;
                                
                                if (!$type || !$duration) {
                                    return '‚ûï ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà';
                                }
                                
                                $durationText = match($duration) {
                                    '3_months' => '3‡∏î.',
                                    '6_months' => '6‡∏î.',
                                    '12_months' => '12‡∏î.',
                                    '15_months' => '15‡∏î.',
                                    default => $duration
                                };
                                
                                $label = "üè∑Ô∏è {$type} ({$durationText}) ‚Üí ‡∏ø" . number_format($amount, 0);
                                
                                if ($isDuplicate) {
                                    $label = "‚ö†Ô∏è " . $label . " (‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô!)";
                                }
                                
                                return $label;
                            })
                            ->addActionLabel('‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î')
                            ->collapsible()
                            ->defaultItems(0)
                            ->columns(3),
                    ])
                    ->action(function ($record, $data) {
                        // ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        $unique = [];
                        $keys = [];
                        
                        foreach (($data['discounts'] ?? []) as $discount) {
                            $key = ($discount['insurance_type'] ?? '') . '_' . ($discount['duration'] ?? '');
                            
                            if (isset($keys[$key])) {
                                unset($unique[$keys[$key]]);
                            }
                            
                            unset($discount['is_duplicate']); // ‡∏•‡∏ö field ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                            $unique[] = $discount;
                            $keys[$key] = count($unique) - 1;
                        }
                        
                        $record->update(['discounts' => array_values($unique)]);
                        
                        Notification::make()
                            ->title('‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')
                            ->success()
                            ->send();
                    }),
                
                Action::make('view_discounts')
                    ->label('‡∏î‡∏π‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î')
                    ->icon('heroicon-o-receipt-percent')
                    ->color('success')
                    ->modalHeading(fn ($record) => "‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏Ç‡∏≠‡∏á {$record->name}")
                    ->modalContent(fn ($record) => view('filament.customer-discounts', ['customer' => $record]))
                    ->modalActions([]),
            ])
            ->toolbarActions([
                BulkActionGroup::make([
                    DeleteBulkAction::make(),
                ]),
            ]);
    }

    /**
     * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏ö‡∏ö real-time
     */
    private static function checkDuplicateDiscount($get, $set)
    {
        $discounts = $get('../../discounts') ?? [];
        $currentType = $get('insurance_type');
        $currentDuration = $get('duration');
        
        if (!$currentType || !$currentDuration) {
            $set('is_duplicate', false);
            return;
        }
        
        $currentKey = $currentType . '_' . $currentDuration;
        $duplicateCount = 0;
        
        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
        foreach ($discounts as $discount) {
            $key = ($discount['insurance_type'] ?? '') . '_' . ($discount['duration'] ?? '');
            if ($key === $currentKey) {
                $duplicateCount++;
            }
        }
        
        $isDuplicate = $duplicateCount > 1;
        $set('is_duplicate', $isDuplicate);
        
        if ($isDuplicate) {
            Notification::make()
                ->title('‚ö†Ô∏è ‡∏û‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ã‡πâ‡∏≥')
                ->body("‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {$currentType} ({$currentDuration}) ‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£")
                ->warning()
                ->duration(3000)
                ->send();
        }
    }
}
